set names utf8;
drop database if exists DB;
create database DB charset utf8;
use DB;

create table user
(
    user_id   int primary key auto_increment,#用户编号
    user_name varchar(40),#用户名
    user_pwd  varchar(40)                    #用户密码
);

insert into user
values (null, 'lkl', 'lkl');
insert into user
values (null, 'chx', 'chx');
insert into user
values (null, 'zyd', 'zyd');

create table classroom
(
    class_id   int primary key,#教室编号
    class_loc  varchar(40) null,#教室位置
    class_type varchar(40) null,#教室类型
    class_max  int         null#教室最大容纳人数
);

insert into classroom
values (1, '四教', '小教室', 30);
insert into classroom
values (2, '三教', '小教室', 30);
insert into classroom
values (3, '四教', '小教室', 30);
insert into classroom
values (4, '四教', '小教室', 30);
insert into classroom
values (5, '三教', '中教室', 50);
insert into classroom
values (6, '三教', '中教室', 50);
insert into classroom
values (7, '四教', '中教室', 50);
insert into classroom
values (8, '三教', '大教室', 100);
insert into classroom
values (9, '三教', '大教室', 100);
insert into classroom
values (10, '四教', '大教室', 100);
insert into classroom
values (11, '四教', '大教室', 100);

create table course
(
    course_id      int primary key,#课程编号
    course_name    varchar(40) null,#课程名
    course_teacher varchar(40) null,#授课教师
    course_max     int         null #课程最大人数
);

#insert into course
#values (111, '高等数学', '教师A', 50);
#insert into course
#values (222, '线性代数', '教师B', 200);
#insert into course
#values (333, '概率论与数理统计', '教师C', 100);

create table classroom_course_status
(
    classroom_id int null,#教室编号
    course_id    int null,#课程编号
    week_num     int null,#星期几
    time_num     int null#第几节课
);

create function schedule1(classroomId int, courseId int, weekNum int, timeNum int, number int)
    returns int
begin
    declare a, tem_num int;
    declare flag int;
    set flag = 1;
    select class_max into tem_num from classroom where class_id = classroomId;
    if (number <= tem_num) then
        select count(*) into a from classroom_course_status where classroom_id = classroom_id and week_num = week_num and time_num = timeNum;
        if (a = 0) then
            insert into classroom_course_status value (classroomId, courseId, weekNum, timeNum);
        else
            set flag = 0;
        end if;
    else
        set flag = 0;
    end if;
    return flag;
end;

#select schedule1(102, 111, 4, 2, 30);

create function random_schedule(courseId int, number int)
    returns int
begin
    declare a, i, max int;
    declare flag int;
    declare tem_num int;
    declare week, time int;

    set week = 1;
    set time = 1;
    set flag = 1;
    set i = 0;
    select count(*) from classroom into max;
    outer_label:
    begin
        while(i < max)
            do
                select class_max into tem_num from classroom limit i, 1;
                if (tem_num >= number) then
                    while(week < 6)
                        do
                            while (time < 6)
                                do
                                    select count(*)
                                    into a
                                    from classroom_course_status
                                    where classroom_id = i+1 and week_num = week and time_num = time;
                                    if (a = 0) then
                                        insert into classroom_course_status value (i+1, courseId, week, time);
                                        leave outer_label;
                                    end if;
                                    set time = time + 1;
                                end while;
                            set time = 1;
                            set week = week + 1;
                        end while;
                    set week = 1;
                end if;
                set i = i + 1;
            end while;
    end outer_label;
    if (i = max) then
        set flag = 0;
    end if;
    return flag;
end;

#select random_schedule(111,  30);
#select random_schedule(111,  500);

select *
from user
where user_name = 'a';

create procedure Insert_user(user varchar(40), pwd varchar(40))
begin
    insert into user values (null, user, pwd);
end;
